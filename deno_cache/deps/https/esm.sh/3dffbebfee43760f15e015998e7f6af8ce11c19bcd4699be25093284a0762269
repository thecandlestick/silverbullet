/* esm.sh - esbuild bundle(y-codemirror.next@0.3.2) deno production */
import*as W from"yjs";import*as j from"@codemirror/view";import"@codemirror/state";import*as f from"yjs";import*as y from"@codemirror/state";import*as z from"@codemirror/view";import*as S from"yjs";var x=class{constructor(t,e){this.yanchor=t,this.yhead=e}toJSON(){return{yanchor:S.relativePositionToJSON(this.yanchor),yhead:S.relativePositionToJSON(this.yhead)}}static fromJSON(t){return new x(S.createRelativePositionFromJSON(t.yanchor),S.createRelativePositionFromJSON(t.yhead))}};var M=class{constructor(t,e){this.ytext=t,this.awareness=e,this.undoManager=new f.UndoManager(t)}toYPos(t,e=0){return f.createRelativePositionFromTypeIndex(this.ytext,t,e)}fromYPos(t){let e=f.createAbsolutePositionFromRelativePosition(f.createRelativePositionFromJSON(t),this.ytext.doc);if(e==null||e.type!==this.ytext)throw new Error("[y-codemirror] The position you want to retrieve was created by a different document");return{pos:e.index,assoc:e.assoc}}toYRange(t){let e=t.assoc,o=this.toYPos(t.anchor,e),n=this.toYPos(t.head,e);return new x(o,n)}fromYRange(t){let e=this.fromYPos(t.yanchor),o=this.fromYPos(t.yhead);return e.pos===o.pos?y.EditorSelection.cursor(o.pos,o.assoc):y.EditorSelection.range(e.pos,o.pos)}},g=y.Facet.define({combine(r){return r[r.length-1]}}),P=y.Annotation.define(),A=class{constructor(t){this.view=t,this.conf=t.state.facet(g),this._observer=(e,o)=>{if(o.origin!==this.conf){let n=e.delta,s=[],i=0;for(let c=0;c<n.length;c++){let a=n[c];a.insert!=null?s.push({from:i,to:i,insert:a.insert}):a.delete!=null?(s.push({from:i,to:i+a.delete,insert:""}),i+=a.delete):i+=a.retain}t.dispatch({changes:s,annotations:[P.of(this.conf)]})}},this._ytext=this.conf.ytext,this._ytext.observe(this._observer)}update(t){if(!t.docChanged||t.transactions.length>0&&t.transactions[0].annotation(P)===this.conf)return;let e=this.conf.ytext;e.doc.transact(()=>{let o=0;t.changes.iterChanges((n,s,i,c,a)=>{let d=a.sliceString(0,a.length,`
`);n!==s&&e.delete(n+o,s-n),d.length>0&&e.insert(n+o,d),o+=d.length-(s-n)})},this.conf)}destroy(){this._ytext.unobserve(this._observer)}},$=z.ViewPlugin.fromClass(A);import*as l from"@codemirror/view";import*as Y from"@codemirror/state";import*as u from"/v119/lib0@0.2.74/X-ZS9AY29kZW1pcnJvci9jb21tYW5kcyxAY29kZW1pcnJvci9oaXN0b3J5LEBjb2RlbWlycm9yL3N0YXRlLEBjb2RlbWlycm9yL3ZpZXcseWpz/deno/dom.js";import*as w from"/v119/lib0@0.2.74/X-ZS9AY29kZW1pcnJvci9jb21tYW5kcyxAY29kZW1pcnJvci9oaXN0b3J5LEBjb2RlbWlycm9yL3N0YXRlLEBjb2RlbWlycm9yL3ZpZXcseWpz/deno/pair.js";import*as C from"/v119/lib0@0.2.74/X-ZS9AY29kZW1pcnJvci9jb21tYW5kcyxAY29kZW1pcnJvci9oaXN0b3J5LEBjb2RlbWlycm9yL3N0YXRlLEBjb2RlbWlycm9yL3ZpZXcseWpz/deno/math.js";import*as m from"yjs";var H=l.EditorView.baseTheme({".cm-ySelection":{},".cm-yLineSelection":{padding:0,margin:"0px 2px 0px 4px"},".cm-ySelectionCaret":{position:"relative",borderLeft:"1px solid black",borderRight:"1px solid black",marginLeft:"-1px",marginRight:"-1px",boxSizing:"border-box",display:"inline"},".cm-ySelectionCaretDot":{borderRadius:"50%",position:"absolute",width:".4em",height:".4em",top:"-.2em",left:"-.2em",backgroundColor:"inherit",transition:"transform .3s ease-in-out",boxSizing:"border-box"},".cm-ySelectionCaret:hover > .cm-ySelectionCaretDot":{transformOrigin:"bottom center",transform:"scale(0)"},".cm-ySelectionInfo":{position:"absolute",top:"-1.05em",left:"-1px",fontSize:".75em",fontFamily:"serif",fontStyle:"normal",fontWeight:"normal",lineHeight:"normal",userSelect:"none",color:"white",paddingLeft:"2px",paddingRight:"2px",zIndex:101,transition:"opacity .3s ease-in-out",backgroundColor:"inherit",opacity:0,transitionDelay:"0s",whiteSpace:"nowrap"},".cm-ySelectionCaret:hover > .cm-ySelectionInfo":{opacity:1,transitionDelay:"0s"}}),Q=Y.Annotation.define(),L=class extends l.WidgetType{constructor(t,e){super(),this.color=t,this.name=e}toDOM(){return u.element("span",[w.create("class","cm-ySelectionCaret"),w.create("style",`background-color: ${this.color}; border-color: ${this.color}`)],[u.text("\u2060"),u.element("div",[w.create("class","cm-ySelectionCaretDot")]),u.text("\u2060"),u.element("div",[w.create("class","cm-ySelectionInfo")],[u.text(this.name)]),u.text("\u2060")])}eq(t){return t.color===this.color}compare(t){return t.color===this.color}updateDOM(){return!1}get estimatedHeight(){return-1}ignoreEvent(){return!0}},J=class{constructor(t){this.conf=t.state.facet(g),this._listener=({added:e,updated:o,removed:n},s,i)=>{e.concat(o).concat(n).findIndex(a=>a!==this.conf.awareness.doc.clientID)>=0&&t.dispatch({annotations:[Q.of([])]})},this._awareness=this.conf.awareness,this._awareness.on("change",this._listener),this.decorations=Y.RangeSet.of([])}destroy(){this._awareness.off("change",this._listener)}update(t){let e=this.conf.ytext,o=e.doc,n=this.conf.awareness,s=[],i=this.conf.awareness.getLocalState();if(i!=null){let c=t.view.hasFocus&&t.view.dom.ownerDocument.hasFocus(),a=c?t.state.selection.main:null,d=i.cursor==null?null:m.createRelativePositionFromJSON(i.cursor.anchor),p=i.cursor==null?null:m.createRelativePositionFromJSON(i.cursor.head);if(a!=null){let h=m.createRelativePositionFromTypeIndex(e,a.anchor),b=m.createRelativePositionFromTypeIndex(e,a.head);(i.cursor==null||!m.compareRelativePositions(d,h)||!m.compareRelativePositions(p,b))&&n.setLocalStateField("cursor",{anchor:h,head:b})}else i.cursor!=null&&c&&n.setLocalStateField("cursor",null)}n.getStates().forEach((c,a)=>{if(a===n.doc.clientID)return;let d=c.cursor;if(d==null||d.anchor==null||d.head==null)return;let p=m.createAbsolutePositionFromRelativePosition(d.anchor,o),h=m.createAbsolutePositionFromRelativePosition(d.head,o);if(p==null||h==null||p.type!==e||h.type!==e)return;let{color:b="#30bced",name:G="Anonymous"}=c.user||{},k=c.user&&c.user.colorLight||b+"33",T=C.min(p.index,h.index),O=C.max(p.index,h.index),_=t.view.state.doc.lineAt(T),V=t.view.state.doc.lineAt(O);if(_.number===V.number)s.push({from:T,to:O,value:l.Decoration.mark({attributes:{style:`background-color: ${k}`},class:"cm-ySelection"})});else{s.push({from:T,to:_.from+_.length,value:l.Decoration.mark({attributes:{style:`background-color: ${k}`},class:"cm-ySelection"})}),s.push({from:V.from,to:O,value:l.Decoration.mark({attributes:{style:`background-color: ${k}`},class:"cm-ySelection"})});for(let I=_.number+1;I<V.number;I++){let E=t.view.state.doc.line(I).from;s.push({from:E,to:E,value:l.Decoration.line({attributes:{style:`background-color: ${k}`,class:"cm-yLineSelection"}})})}}s.push({from:h.index,to:h.index,value:l.Decoration.widget({side:h.index-p.index>0?-1:1,block:!1,widget:new L(b,G)})})}),this.decorations=l.Decoration.set(s,!0)}},B=l.ViewPlugin.fromClass(J,{decorations:r=>r.decorations});import"yjs";import*as D from"@codemirror/state";import*as K from"@codemirror/view";import{createMutex as X}from"/v119/lib0@0.2.74/X-ZS9AY29kZW1pcnJvci9jb21tYW5kcyxAY29kZW1pcnJvci9oaXN0b3J5LEBjb2RlbWlycm9yL3N0YXRlLEBjb2RlbWlycm9yL3ZpZXcseWpz/deno/mutex.js";var R=class{constructor(t){this.undoManager=t}addTrackedOrigin(t){this.undoManager.addTrackedOrigin(t)}removeTrackedOrigin(t){this.undoManager.removeTrackedOrigin(t)}undo(){return this.undoManager.undo()!=null}redo(){return this.undoManager.redo()!=null}},v=D.Facet.define({combine(r){return r[r.length-1]}}),ct=D.Annotation.define(),N=class{constructor(t){this.view=t,this.conf=t.state.facet(v),this._undoManager=this.conf.undoManager,this.syncConf=t.state.facet(g),this._beforeChangeSelection=null,this._mux=X(),this._onStackItemAdded=({stackItem:e,changedParentTypes:o})=>{o.has(this.syncConf.ytext)&&this._beforeChangeSelection&&!e.meta.has(this)&&e.meta.set(this,this._beforeChangeSelection)},this._onStackItemPopped=({stackItem:e})=>{let o=e.meta.get(this);if(o){let n=this.syncConf.fromYRange(o);t.dispatch(t.state.update({selection:n})),this._storeSelection()}},this._storeSelection=()=>{this._beforeChangeSelection=this.syncConf.toYRange(this.view.state.selection.main)},this._undoManager.on("stack-item-added",this._onStackItemAdded),this._undoManager.on("stack-item-popped",this._onStackItemPopped),this._undoManager.addTrackedOrigin(this.syncConf)}update(t){t.selectionSet&&(t.transactions.length===0||t.transactions[0].annotation(P)!==this.syncConf)&&this._storeSelection()}destroy(){this._undoManager.off("stack-item-added",this._onStackItemAdded),this._undoManager.off("stack-item-popped",this._onStackItemPopped),this._undoManager.removeTrackedOrigin(this.syncConf)}},q=K.ViewPlugin.fromClass(N),U=({state:r,dispatch:t})=>r.facet(v).undo()||!0,F=({state:r,dispatch:t})=>r.facet(v).redo()||!0;var Z=[{key:"Mod-z",run:U,preventDefault:!0},{key:"Mod-y",mac:"Mod-Shift-z",run:F,preventDefault:!0},{key:"Mod-Shift-z",run:F,preventDefault:!0}];var ft=(r,t,{undoManager:e=new W.UndoManager(r)}={})=>{let o=new M(r,t),n=[g.of(o),$];return t&&n.push(H,B),e!==!1&&n.push(v.of(new R(e)),q,j.EditorView.domEventHandlers({beforeinput(s,i){return s.inputType==="historyUndo"?U(i):s.inputType==="historyRedo"?F(i):!1}})),n};export{M as YSyncConfig,ft as yCollab,B as yRemoteSelections,H as yRemoteSelectionsTheme,$ as ySync,g as ySyncFacet,Z as yUndoManagerKeymap};
//# sourceMappingURL=y-codemirror.next.mjs.map